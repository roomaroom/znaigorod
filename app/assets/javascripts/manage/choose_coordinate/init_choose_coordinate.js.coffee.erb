$map = null
$marker = null

$.fn.show_map = (coordinate) ->
  return $map if $map?
  container = this[0]
  if coordinate != null
    point = new DG.GeoPoint(coordinate.lon, coordinate.lat)
  else
    point = new DG.GeoPoint('84.952222232222', '56.488611121111')
  map = new DG.Map(container)
  scale = 16
  DG.load ->
  map.controls.add(new DG.Controls.Zoom())
  map.fullscreen.disable()
  map.setCenter(point, scale)
  return map

create_marker = (coordinate) ->
  new DG.Markers.Common {
    geoPoint: new DG.GeoPoint(coordinate.lon, coordinate.lat),
    icon: new DG.Icon(
      '/assets/pin.png',
      new DG.Size(24, 24),
      ->
        new DG.Point(-26, -30)
    )
  }

$.fn.add_click_handler = () ->
  $this = $(this)
  $this.click ->
    if $('.map_wrapper').length
      container = $('.map_wrapper')
    else
      container = $('<div class="map_wrapper" style="width:640px; height: 480px;" />').appendTo('body').hide()
    latitude = $('.latitude', $(this).parent())
    longitude = $('.longitude', $(this).parent())
    observer = null
    coordinate = null
    if latitude.val().length
      coordinate = { 'lat': latitude.val(), 'lon': longitude.val() }

    container.dialog(
      draggable: false
      height: 480
      resizable: false
      title: 'Укажите координаты места проведения'
      width: 640
      zIndex: 700
      open: ->
        $map = container.show_map(coordinate)
        if coordinate != null
          $map.markers.remove($marker) if $marker != null
          $marker = create_marker(coordinate)
          $map.markers.add($marker)
          $map.setCenter(new DG.GeoPoint(coordinate.lon, coordinate.lat), 16)
        observer = $map.addEventListener($map.getContainerId(),'DgClick', (event) ->
          coordinate = event.getGeoPoint()
          latitude.val coordinate.lat
          longitude.val coordinate.lon
          $this.addClass('with_coordinates')
          $map.markers.remove($marker) if $marker != null
          $marker = create_marker(coordinate)
          $map.markers.add($marker)
          $marker = $marker.getId()
        )
      close: ->
        observer.cleanup()
    )

    false

@init_choose_coordinate = () ->
  link = $('.choose_coordinate')
  link.add_click_handler()
  $('form').on('nested:fieldAdded', (event) ->
    $(event.field).find('.choose_coordinate').filter(':visible').last().add_click_handler()
  )
